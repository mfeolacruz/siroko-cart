#!/bin/sh

echo "üîç Running pre-commit checks..."

# Check PHPStan
echo "üìä Running PHPStan..."
docker compose exec -T php vendor/bin/phpstan analyse
phpstan_exit=$?

# Allow exit code 0 (success) or exit code when no files found
if [ $phpstan_exit -ne 0 ]; then
    # Check if it's just "no files found" error
    if docker compose exec -T php vendor/bin/phpstan analyse 2>&1 | grep -q "No files found to analyse"; then
        echo "‚ö†Ô∏è  PHPStan: No files to analyse yet (OK for initial setup)"
    else
        echo "‚ùå PHPStan failed. Fix errors before committing."
        exit 1
    fi
fi

# Check PHP CS Fixer
echo "üé® Checking code style..."
docker compose exec -T php vendor/bin/php-cs-fixer fix --dry-run --diff
if [ $? -ne 0 ]; then
    echo "‚ùå Code style issues found. Run 'make cs-fix' to fix them."
    exit 1
fi

echo "‚úÖ All pre-commit checks passed!"
exit 0
